<head>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react/15.4.2/react.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react/15.4.2/react-dom.js"></script>
  <script src="http://code.jquery.com/jquery-1.7.1.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/redux/4.0.0/redux.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/redux/4.0.0/redux.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react-redux/5.0.7/react-redux.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react-redux/5.0.7/react-redux.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.1.0/jquery.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.0/jquery-ui.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/6.21.1/babel.min.js"></script>
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
  <link rel="stylesheet" href="css/style.css">
</head>

<div id="root"></div>

<script type="text/babel">

  const digits = [
  {
    value: "zero",
    symbol: "0"
  },
  {
    value: "decimal",
    symbol: "."
  },
  {
    value: "one",
    symbol: 1
  },
  {
    value: "two",
    symbol: "2"
  },
  {
    value: "three",
    symbol: "3"
  },
  {
    value: "four",
    symbol: "4"
  },
  {
    value: "five",
    symbol: "5"
  },
  {
    value: "six",
    symbol: "6"
  },
  {
    value: "seven",
    symbol: "7"
  },
  {
    value: "eight",
    symbol: "8"
  },
  {
    value: "nine",
    symbol: "9"
  }
  ];
  const operations = [
  {
    op: "add",
    symbol: "+"
  },
  {
    op: "subtract",
    symbol: "-"
  },
  {
    op: "multiply",
    symbol: "*"
  },
  {
    op: "divide",
    symbol: "/"
  },
  {
    op: "equals",
    symbol:"="
  },
  {
    op: "clear",
    symbol: "CLR"
  }
];

  // Redux
  const CLEAR = 'CLEAR';
  const EQUAL = 'EQUAL'
  const DIGIT = 'DIGIT';
  const OPERATION = 'OPERATION';

  const addSymbol = (symbol) => {
    if (symbol == "CLR"){
      return {
        type: CLEAR,
        symbol: symbol
      }
    } else if (symbol == "="){
      return{
        type: EQUAL,
        symbol: symbol
      }
    } else if (digits.some(digit => digit['symbol'] == symbol)){
      return {
        type: DIGIT,
        symbol: symbol
      }
    } else {
      return {
        type: OPERATION,
        symbol: symbol
      }
    }
  };

  const symbolReducer = (state = [], action) => {
    var newState = [...state];
    switch (action.type) {
      case CLEAR:
        return [];
      case EQUAL:
          // calculate state
          const plusMinus = (op, index) =>{
            if (op == "+"){
              return parseFloat(newState[index-1]) + parseFloat(newState[index+1]);
            } else {
              return parseFloat(newState[index-1]) - parseFloat(newState[index+1]);
            }
          }
          const multDiv = (op, index) =>{
            if (op == "*"){
              return parseFloat(newState[index-1]) * parseFloat(newState[index+1]);
            }
            if (op == "/"){
              return parseFloat(newState[index-1]) / parseFloat(newState[index+1]);
            }
          }

          while(newState.length != 1){
            if (newState.length % 2 == 0){
              console.log("incomplete Equation")
              return state
            }
            if (newState[1] == "+" || newState[1] == "-"){
              if (newState[3] == "*" || newState[3] == "/"){
                newState.splice(2,3, multDiv(newState[3],3).toString())
              } else {
                newState.splice(0,3, plusMinus(newState[1],1).toString())
              }
            } else {
              newState.splice(0,3, multDiv(newState[1],1).toString())
            }
          }
          return newState
      case DIGIT:
        if (newState.length == 0){
          newState = [...state, action.symbol];
        } else {
          newState[newState.length - 1] = newState[newState.length - 1] + action.symbol;
        }
        return newState;
      case OPERATION:
          if (newState.length == 0){
            console.log("Error " + action.symbol + " must be after a number.")
          } else {
            newState.push(action.symbol);
            newState.push("")
          }
          return newState;
      default:
        return state;
    }
  };

  const store = Redux.createStore(symbolReducer);

  class NumberPad extends React.Component{
    constructor(props){
      super(props);
      this.handleNumClick = this.handleNumClick.bind(this);
    }

    handleNumClick(event){
      this.props.updateSymbol(event.target.value);
    }

    render(){
      const row = (rowContent) =>{
        var elementClass = "padCasing col-xs-4"
        return rowContent.map(function(digit){
          return(
            <div className={elementClass}  key={digit.value}>
              <button className="padButton" id={digit.value} onClick={this.handleNumClick} value={digit.symbol}>{digit.symbol}</button>
            </div>
          )
        },this);
      }
      const row1 = row(digits.slice(8,11))
      const row2 = row(digits.slice(5,8))
      const row3 = row(digits.slice(2,5))
      const row4 = row(digits.slice(0,2))

      return(
        <div id="numberPad">
          <div className="row">
            {row1}
          </div>
          <div className="row">
            {row2}
          </div>
          <div className="row">
            {row3}
          </div>
          <div className="row">
            {row4}
          </div>
        </div>
      )
    }
  }

  class OperationPad extends React.Component{
    constructor(props){
      super(props);
      this.handleOpClick=this.handleOpClick.bind(this);
    }

    handleOpClick(event){
      this.props.updateSymbol(event.target.value);
    }

    render(){
      const row = (rowContent) =>{
        var elementClass = "padCasing col-xs-4"
        return rowContent.map(function(op){
          return(
            <div className={elementClass}  key={op.op}>
              <button className="padButton" id={op.op} onClick={this.handleOpClick} value={op.symbol}>{op.symbol}</button>
            </div>
          )
        },this);
      }

      const row1 = row(operations.slice(0,2))
      const row2 = row(operations.slice(2,4))
      const row3 = row(operations.slice(4,6))

      return(
        <div id="operationPad">
          <div className="row">
            <div className="col-xs-4"/>
            {row1}
          </div>
          <div className="row">
            <div className="col-xs-4"/>
            {row2}
          </div>
          <div className="row">
            <div className="col-xs-4"/>
            {row3}
          </div>
        </div>
      )
    }
  }

  class Root extends React.Component{
    constructor(props){
      super(props)
      this.submitSymbol = this.submitSymbol.bind(this);
    }

    submitSymbol(val){
      this.props.submitNewSymbol(val);
    }

    render(){
      console.log(store.getState())
      return (
        <div id="calculator" className="container">
          <div className="row">
            <div id="display" className="col-xs-12 ">
              <div id="value">
                {store.getState()}
              </div>
            </div>
          </div>
          <div className="row">
              <div id="pad" className="col-xs-12">
              <div className="row">
                <div className="col-xs-6">
                  <NumberPad updateSymbol={this.submitSymbol}/>
                </div>
                <div className="col-xs-6">
                  <OperationPad updateSymbol={this.submitSymbol}/>
                </div>
              </div>
            </div>
          </div>
        </div>
      )
    }
  }

  const mapStateToProps = (state) => {
    return {symbols: state}
  };

  const mapDispatchToProps = (dispatch) => {
    return {
      submitNewSymbol: (symbol) => {
        dispatch(addSymbol(symbol))
      }
    }
  };

  const Provider = ReactRedux.Provider;
  const connect = ReactRedux.connect;

  const Container = connect(mapStateToProps, mapDispatchToProps)(Root);

  class AppWrapper extends React.Component {
    render() {
      return (
        <Provider store={store}>
          <Container/>
        </Provider>
      );
    }
  };

  ReactDOM.render(<AppWrapper />, document.getElementById('root'))
</script>
